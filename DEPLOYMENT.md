# Deploying Student Placement Assistant to Render (Free Tier)

## Architecture Overview

In production, the app runs as a **single Render web service**:
- Express backend serves the API (`/api/*` routes)
- Express also serves the built React frontend (all other routes)
- MongoDB Atlas provides the database (free M0 cluster)
- No separate frontend hosting needed

---

## Step 1: Set Up MongoDB Atlas (Free Tier)

1. Go to [https://www.mongodb.com/atlas](https://www.mongodb.com/atlas) and create a free account
2. Click **"Build a Database"** → select **M0 FREE** tier
3. Choose a cloud provider and region (pick one close to your Render region, e.g., AWS US East)
4. Set a **cluster name** (e.g., `spa-cluster`)
5. Click **Create Deployment**

### Create a Database User
1. Go to **Database Access** in the left sidebar
2. Click **Add New Database User**
3. Choose **Password** authentication
4. Set a username (e.g., `spa-user`) and a strong password
5. Under **Database User Privileges**, select **Read and write to any database**
6. Click **Add User**

### Allow Network Access
1. Go to **Network Access** in the left sidebar
2. Click **Add IP Address**
3. Click **Allow Access from Anywhere** (adds `0.0.0.0/0`) — required for Render
4. Click **Confirm**

### Get Your Connection String
1. Go to **Database** → click **Connect** on your cluster
2. Select **Drivers** (Node.js)
3. Copy the connection string — it looks like:
   ```
   mongodb+srv://spa-user:<password>@spa-cluster.xxxxx.mongodb.net/?retryWrites=true&w=majority
   ```
4. Replace `<password>` with your actual password
5. Add the database name before the `?`:
   ```
   mongodb+srv://spa-user:YOUR_PASSWORD@spa-cluster.xxxxx.mongodb.net/student-placement-assistant?retryWrites=true&w=majority
   ```
6. **Save this string** — you'll need it for Render environment variables

---

## Step 2: Push Code to GitHub

Make sure your code is in a GitHub repository:

```bash
cd student-placement-assistant
git init
git add .
git commit -m "Prepare for Render deployment"
git remote add origin https://github.com/YOUR_USERNAME/student-placement-assistant.git
git push -u origin main
```

> **IMPORTANT:** Verify `.env` is in `.gitignore` so your secrets are never committed.

---

## Step 3: Deploy on Render

### Option A: Using render.yaml (Blueprint — Recommended)

1. Go to [https://render.com](https://render.com) and sign up / log in
2. Click **New** → **Blueprint**
3. Connect your GitHub repository
4. Render will detect `render.yaml` and auto-configure the service
5. You'll be prompted to set the environment variables marked as `sync: false`:
   - **`MONGODB_URI`** — paste your MongoDB Atlas connection string from Step 1
   - **`ANTHROPIC_API_KEY`** — your Anthropic API key
6. `JWT_SECRET` is auto-generated by Render (via `generateValue: true`)
7. Click **Apply**

### Option B: Manual Setup

1. Go to [https://render.com](https://render.com) and sign up / log in
2. Click **New** → **Web Service**
3. Connect your GitHub repository
4. Configure the service:

   | Setting         | Value                        |
   |-----------------|------------------------------|
   | **Name**        | `student-placement-assistant` |
   | **Runtime**     | `Node`                       |
   | **Build Command** | `npm run render-build`     |
   | **Start Command** | `npm run start`            |
   | **Plan**        | `Free`                       |

5. Add **Environment Variables**:

   | Key                | Value                                    |
   |--------------------|------------------------------------------|
   | `NODE_ENV`         | `production`                             |
   | `MONGODB_URI`      | Your MongoDB Atlas connection string     |
   | `JWT_SECRET`       | A long random string (use `openssl rand -hex 32`) |
   | `ANTHROPIC_API_KEY`| Your Anthropic API key                   |

6. Click **Create Web Service**

---

## Step 4: Verify Deployment

1. Render will build and deploy your app (takes 3-5 minutes on first deploy)
2. Once deployed, visit your app URL: `https://student-placement-assistant.onrender.com`
3. Test the health endpoint: `https://student-placement-assistant.onrender.com/api/health`
   - Should return: `{"status":"ok","environment":"production"}`
4. Test the full flow:
   - Sign up for a new account
   - Fill in your profile
   - Create an assessment
   - View the results

---

## How It Works in Production

### Build Phase (`npm run render-build`)
```
cd server && npm install       ← Install backend dependencies
cd ../client && npm install    ← Install frontend dependencies
npm run build                  ← Vite builds React app into client/dist/
```

### Start Phase (`npm run start`)
```
cd server && node server.js    ← Express starts and:
  1. Serves API routes on /api/*
  2. Serves client/dist/ as static files
  3. All other routes → index.html (SPA routing)
```

### Request Flow
```
Browser → Render URL
  ├── /api/*           → Express API handlers
  ├── /assets/*        → Static files from client/dist/
  └── /* (everything)  → client/dist/index.html → React Router
```

---

## Deployment Checklist

- [ ] MongoDB Atlas cluster created (M0 free tier)
- [ ] Database user created with read/write access
- [ ] Network access set to allow all IPs (`0.0.0.0/0`)
- [ ] Connection string tested and includes database name
- [ ] Code pushed to GitHub (`.env` is NOT committed)
- [ ] Render web service created
- [ ] Environment variables set: `NODE_ENV`, `MONGODB_URI`, `JWT_SECRET`, `ANTHROPIC_API_KEY`
- [ ] Build succeeds on Render (check Render logs)
- [ ] Health check passes: `/api/health`
- [ ] Signup/Login works
- [ ] Profile creation works
- [ ] Assessment creation works (confirms Claude API key is valid)
- [ ] Client-side routing works (refresh on `/dashboard` doesn't 404)

---

## Troubleshooting

### App crashes on startup
- Check Render logs for the error
- Most common: invalid `MONGODB_URI` — double-check the password and database name

### "Cannot connect to MongoDB"
- Verify Atlas Network Access allows `0.0.0.0/0`
- Verify the connection string password has no special characters that need URL-encoding
- Special characters in passwords (`@`, `#`, `%`, etc.) must be [percent-encoded](https://www.mongodb.com/docs/manual/reference/connection-string/#special-characters-in-connection-string-password)

### 404 on page refresh
- This means the catch-all route isn't working. Check that `NODE_ENV=production` is set in Render

### Assessment creation fails
- Verify `ANTHROPIC_API_KEY` is set correctly in Render environment variables
- Check Render logs for Claude API errors

### Free tier cold starts
- Render free tier spins down after 15 minutes of inactivity
- First request after idle takes ~30-60 seconds to cold start
- This is normal for the free tier

---

## Environment Variables Reference

| Variable           | Required | Description                          | Example                                |
|--------------------|----------|--------------------------------------|----------------------------------------|
| `NODE_ENV`         | Yes      | Must be `production` on Render       | `production`                           |
| `PORT`             | No       | Render sets this automatically       | `10000` (Render default)               |
| `MONGODB_URI`      | Yes      | MongoDB Atlas connection string      | `mongodb+srv://user:pass@cluster.mongodb.net/student-placement-assistant` |
| `JWT_SECRET`       | Yes      | Secret for signing JWT tokens        | (random 64-char hex string)            |
| `ANTHROPIC_API_KEY`| Yes      | Anthropic API key for Claude         | `sk-ant-api03-...`                     |
